<!DOCTYPE html>

<html>
<head>
  <title>portfolio.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="auth.html">
                  auth.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="newsfeed.html">
                  newsfeed.js
                </a>
              
                
                <a class="source" href="portfolio.html">
                  portfolio.js
                </a>
              
                
                <a class="source" href="profile.html">
                  profile.js
                </a>
              
                
                <a class="source" href="transactionHist.html">
                  transactionHist.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>portfolio.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>angular.module(<span class="hljs-string">'app.portfolio'</span>, [<span class="hljs-string">"chart.js"</span>])</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2> Portfolio Controller </h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>.controller(<span class="hljs-string">'PortfolioController'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$scope, $location, $mdDialog, Portfolio, Auth, $rootScope, Scores, TransactionHist, User</span>) </span>{
  $scope.investments;
  $scope.clickedInvestment;
  $scope.currentUserInfo = <span class="hljs-string">"invalid"</span>;
  $scope.labels = [];
  $scope.transactions = []
  $scope.openTransactions = [];
  $scope.currentInvestmentsView = <span class="hljs-literal">true</span>;
  $scope.openTransactionsView = <span class="hljs-literal">false</span>;
  $scope.transactionHistoryView = <span class="hljs-literal">false</span>;
  $scope.query = {
    order: <span class="hljs-string">'name'</span>,
    limit: <span class="hljs-number">1</span>,
    page: <span class="hljs-number">1</span>
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3>$scope.getUserById</h3>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Grabs the logged in userâ€™s portfolio information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.getUserById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
    User.getUser(id)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
      $scope.loggedinUserInfo = user[<span class="hljs-number">0</span>];
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h3>setupCalls</h3>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Gets transaction history and loads the graph with labels on page load</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> setupCalls = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    $scope.getTransactionHist();
    $scope.addLabels(<span class="hljs-number">30</span>)
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>$scope.getInvestments</h3>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Grabs all the current investment of the logged in user
properties on an investment object are currentScore, data, id, name, numberShares, series, target_id, user_id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.getInvestments = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
    Portfolio.getInvestments(id)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">investments</span>) </span>{
      $scope.investments = investments;
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>Investment graph functions</h3>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>$scope.getScores</h3>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Uses the investment objects to calculate the score history of the investment so that the graph can be representative</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.getScores = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">target_id, obj</span>) </span>{
    obj.data = [[]];
    obj.series = obj.name;
    Scores.getScores(target_id)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">scoresHist</span>) </span>{
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; scoresHist.length; i++) {
        obj.data[<span class="hljs-number">0</span>].push(scoresHist[i].currentScore);
      }
      <span class="hljs-keyword">var</span> daysBeforeUserJoined = $scope.labels.length - obj.data[<span class="hljs-number">0</span>].length;
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; daysBeforeUserJoined; i++) {
        obj.data[<span class="hljs-number">0</span>].unshift(<span class="hljs-number">0</span>);
      }
      User.getUser(target_id)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
          obj.currentScore = user[<span class="hljs-number">0</span>].currentScore;
          $scope.addProfit(obj);
        });
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>$scope.getTransactionHist</h3>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Gets all transactions for the logged in user
sample properties on a transaction object are id, karma, numberShares, target_id, target_name, type, user_id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.getTransactionHist = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    TransactionHist.getTransactions($rootScope.loggedinUserInfo.id)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">results</span>) </span>{
      $scope.transactions = results.reverse();
      $scope.getInvestments($rootScope.loggedinUserInfo.id);
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>$scope.getOpenUserTransactions</h3>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Gets all pending transactions for the logged in user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.getOpenUserTransactions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> user_id = $rootScope.loggedinUserInfo.id</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Using a hash table to keep track of the openTransaction index of the user in question because of the asynch call below</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> hashedTransactions = {};
    TransactionHist.getOpenUserTransactions(user_id)
    .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">openTransactions</span>) </span>{
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; openTransactions.length; i++) {
        <span class="hljs-keyword">var</span> target_id = openTransactions[i].target_id;
        <span class="hljs-keyword">if</span>(hashedTransactions[target_id]) {
          hashedTransactions[target_id].push(openTransactions[i]);
        } <span class="hljs-keyword">else</span> {
          hashedTransactions[target_id] = [openTransactions[i]];
        }
        User.getUser(openTransactions[i].target_id)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">userInfo</span>) </span>{
          userInfo = userInfo[<span class="hljs-number">0</span>];
          <span class="hljs-keyword">var</span> openTransactionForTarget = hashedTransactions[userInfo.id];
          <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> subI = <span class="hljs-number">0</span>; subI &lt; openTransactionForTarget.length; subI++) {
            <span class="hljs-keyword">var</span> openTransaction = openTransactionForTarget[subI];
            openTransaction.target_name = userInfo.name;
            openTransaction.currentScore = userInfo.currentScore;
          }
        });
      }
      $scope.openTransactions = openTransactions;
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>$scope.addLabels</h3>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Generates labels for the graph. Initially to 30 days in the past however that can be modified in the future</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.addLabels = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">daysInPast</span>) </span>{
    <span class="hljs-keyword">for</span>(; daysInPast &gt;= <span class="hljs-number">0</span>; daysInPast--) {
      <span class="hljs-keyword">if</span>(daysInPast % <span class="hljs-number">5</span> === <span class="hljs-number">0</span>) {
        $scope.labels.push(daysInPast);
      } <span class="hljs-keyword">else</span> {
        $scope.labels.push(<span class="hljs-string">""</span>);
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3>$scope.clickSell</h3>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Opens the Sell Modal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.clickSell = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">investment</span>) </span>{
    $scope.clickedInvestment = investment.id;
    $mdDialog.show({
      templateUrl: <span class="hljs-string">'../app/views/sell.html'</span>,
      locals: {
        investment: investment
      },
      controller: SellModalController
    })
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clickedItem</span>) </span>{
      })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3>$scope.clickCancel</h3>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Cancels an open transaction, removing it from the queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.clickCancel = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">transactionId, index</span>) </span>{
    TransactionHist.deleteOpenTransaction(transactionId).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) </span>{
      <span class="hljs-keyword">if</span>(response.status === <span class="hljs-number">204</span>) {
        $scope.openTransactions.splice(index,<span class="hljs-number">1</span>);
      }
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3>$scope.buildHistString</h3>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Turns a transaction into a human friendly string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.buildHistString = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">transaction</span>) </span>{
    <span class="hljs-keyword">var</span> type = transaction.type === <span class="hljs-string">"buy"</span>? <span class="hljs-string">' bought '</span> : <span class="hljs-string">' sold '</span>;
    <span class="hljs-keyword">var</span> deltaKarma = transaction.type === <span class="hljs-string">"buy"</span>? <span class="hljs-string">' sharing '</span> : <span class="hljs-string">' earning '</span>;
    transaction.string = <span class="hljs-string">"You"</span> + type + transaction.numberShares + <span class="hljs-string">" shares of "</span> + transaction.target_name + deltaKarma + <span class="hljs-built_in">Math</span>.abs(transaction.karma) + <span class="hljs-string">" karma."</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h3>$scope.addProfit</h3>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Searches through the investment history to get the profit for each set of shares</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.addProfit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">investment</span>) </span>{
    <span class="hljs-keyword">var</span> shares = investment.numberShares;
    <span class="hljs-keyword">var</span> profit = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; $scope.transactions.length; i++) {
      <span class="hljs-keyword">var</span> transaction = $scope.transactions[i];

      <span class="hljs-keyword">if</span>(investment.target_id === transaction.target_id) {

        <span class="hljs-keyword">if</span>(shares - transaction.numberShares &gt; <span class="hljs-number">0</span>) {
          profit += (transaction.numberShares * investment.currentScore - transaction.karma)
          shares -= transaction.numberShares
          investment.profit = profit;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> transactionScore = <span class="hljs-built_in">Math</span>.abs(<span class="hljs-built_in">Math</span>.round(transaction.karma / transaction.numberShares))
          profit += (shares * investment.currentScore - shares * transactionScore)
          shares = <span class="hljs-number">0</span>
          investment.profit = profit;
          <span class="hljs-keyword">break</span>;
        }
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h3>$scope.toggleViews</h3>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Switches to different views within the portfolio view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.toggleViews = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">viewToShow</span>) </span>{
    <span class="hljs-keyword">if</span>(viewToShow === <span class="hljs-string">"transactionHistory"</span>) {
      $scope.transactionHistoryView = <span class="hljs-literal">true</span>;
      $scope.currentInvestmentsView = <span class="hljs-literal">false</span>;
      $scope.openTransactionsView = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (viewToShow === <span class="hljs-string">"currentInvestments"</span>) {
      $scope.currentInvestmentsView = <span class="hljs-literal">true</span>;
      $scope.transactionHistoryView = <span class="hljs-literal">false</span>;
      $scope.openTransactionsView = <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> {
      $scope.openTransactionsView = <span class="hljs-literal">true</span>;
      $scope.currentInvestmentsView = <span class="hljs-literal">false</span>;
      $scope.transactionHistoryView = <span class="hljs-literal">false</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3>$scope.toggleOpenTransactions</h3>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Gets the users open transactions and switches the view to the openTransactions view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  $scope.toggleOpenTransactions = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    $scope.getOpenUserTransactions();
    $scope.toggleViews(<span class="hljs-string">'openTransactions'</span>);
  }

  setupCalls();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3>Sell Modal Controller</h3>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The Sell Modal Controller, which handles all possible sell actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SellModalController</span>(<span class="hljs-params">$scope, $mdDialog, $location, investment, TransactionHist, Socket, Scores, User, $rootScope</span>) </span>{
    $scope.investment = investment;
    $scope.requestedShares;
    $scope.requestedSharesInfo;
    $scope.sharesToSell=<span class="hljs-number">0</span>;
    $scope.scores;
    $scope.targetCurrentScore;
    $scope.numSharesInTransactionQueueByUser;
    $scope.revealOptions = <span class="hljs-literal">false</span>;
    $scope.errorMessage = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3>$scope.getUsersOpenSellTransactionsForTarget</h3>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Gets the open sell requests of a target by a certain user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.getUsersOpenSellTransactionsForTarget = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      $scope.numSharesInTransactionQueueByUser = <span class="hljs-number">0</span>;
      TransactionHist.getOpenUserSellTransactionsForTarget($scope.investment.user_id, $scope.investment.target_id)
        .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; response.length; i++) {
            $scope.numSharesInTransactionQueueByUser += response[i].numberShares;
          }
        })
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3>$scope.confirm</h3>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Confirm checks to see if logged in user can sell x number of shares</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.confirm = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Transaction object that is representative of the action the user is taking.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> transaction = {
        user_id: $scope.investment.user_id,
        target_id: $scope.investment.target_id,
        type: <span class="hljs-string">"sell"</span>,
        numberShares: $scope.sharesToSell,
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>User cannot sell more shares than they has or more shares than the amount of their shares not in the transaction queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ($scope.sharesToSell &gt; $scope.investment.numberShares - $scope.numSharesInTransactionQueueByUser) {
        $scope.errorMessage = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        $scope.errorMessage = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> ($scope.sharesToSell &gt; $scope.requestedShares) {
          $scope.revealOptions = <span class="hljs-literal">true</span>;
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"There are not enough matching buy requests to match your request to sell."</span>)
        } <span class="hljs-keyword">else</span> {
          TransactionHist.makeTransaction(transaction)
            .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
              $mdDialog.hide();
              $location.path(<span class="hljs-string">'/portfolio/'</span>+$rootScope.loggedinUserInfo.id);
            })
          <span class="hljs-keyword">if</span> ($scope.requestedSharesInfo &amp;&amp; $scope.requestedSharesInfo.user_id !== $rootScope.loggedinUserInfo.id.toString()) {
            $rootScope.loggedinUserInfo.karma = $rootScope.loggedinUserInfo.karma + ($scope.investment.currentScore * $scope.sharesToSell);
            $scope.investment.numberShares -= $scope.sharesToSell;
          }
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"You successfully sold shares."</span>);
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3>$scope.exit</h3>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Exit exits out of the Sell modal. This is used for the ng-click event to exit the modal controller.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.exit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      $mdDialog.hide();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3>$scope.wait</h3>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Wait will sell shares equivalent to amount currently available and place the rest of the shares in
the transaction queue as a sell request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.wait = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> transaction = {
        user_id: $scope.investment.user_id,
        target_id: $scope.investment.target_id,
        type: <span class="hljs-string">"sell"</span>,
        numberShares: $scope.requestedShares,
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>User cannot sell more shares than they has or more shares than the amount of their shares not in the transaction queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ($scope.sharesToSell &gt; $scope.investment.numberShares - $scope.numSharesInTransactionQueueByUser) {
        $scope.errorMessage = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Sells number of shares equal to the amount requested and places the rest in the transaction queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $scope.errorMessage = <span class="hljs-literal">false</span>;
        TransactionHist.makeTransaction(transaction).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          transaction.numberShares = $scope.sharesToSell - $scope.requestedShares;
          TransactionHist.addTransactionToQueue(transaction);
        });
        Scores.updateSocialInvestment($scope.investment.target_id);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Logic to handle whether a user is selling shares to himself. This prevents any changing of the users scores</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ($scope.requestedSharesInfo &amp;&amp; $scope.requestedSharesInfo.user_id !== $rootScope.loggedinUserInfo.id.toString()) {
          $rootScope.loggedinUserInfo.karma += $scope.investment.currentScore * ($scope.requestedShares)
          $scope.investment.numberShares -= $scope.requestedShares;
        }
      }
      $mdDialog.hide();
      $location.path(<span class="hljs-string">'/portfolio/'</span> + $rootScope.loggedinUserInfo.id)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h3>$scope.sellDirect</h3>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>sellDirect will sell shares directly to Karma Exchange at 90% market value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.sellDirect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> transaction = {
        user_id: $scope.investment.user_id,
        target_id: $scope.investment.target_id,
        type: <span class="hljs-string">"sell"</span>,
        numberShares: $scope.requestedShares,
      }
      <span class="hljs-keyword">var</span> newScore = $scope.investment.currentScore * <span class="hljs-number">0.9</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>User cannot sell more shares than they has or more shares than the amount of their shares not in the transaction queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ($scope.sharesToSell &gt; $scope.investment.numberShares - $scope.numSharesInTransactionQueueByUser) {
        $scope.errorMessage = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        $scope.errorMessage = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> ($scope.requestedShares) {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>If there are requested shares in the transaction queue, make a transaction of just the requested shares.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          TransactionHist.makeTransaction(transaction).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            transaction.numberShares = $scope.sharesToSell - $scope.requestedShares;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Update the transaction to include only the shares that will be bought directly and provide a newScore at which to buy the shares.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            TransactionHist.closeTransactionRequest(transaction, newScore);
          })
        } <span class="hljs-keyword">else</span> {
          transaction.numberShares = $scope.sharesToSell;
          TransactionHist.closeTransactionRequest(transaction, newScore);
        }
        Scores.updateSocialInvestment($scope.investment.target_id);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Updates the karma and the number of shares the user owns on the front-end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ($scope.requestedSharesInfo &amp;&amp; $scope.requestedSharesInfo.user_id !== $rootScope.loggedinUserInfo.id.toString()) {
          $scope.investment.numberShares -=$scope.sharesToSell;
          $rootScope.loggedinUserInfo.karma += <span class="hljs-built_in">Math</span>.round($scope.investment.currentScore * $scope.requestedShares + newScore * ($scope.sharesToSell - $scope.requestedShares));
        } <span class="hljs-keyword">else</span> {
          $scope.investment.numberShares -= $scope.sharesToSell - $scope.requestedShares;
          $rootScope.loggedinUserInfo.karma += <span class="hljs-built_in">Math</span>.round(newScore * ($scope.sharesToSell - $scope.requestedShares));
        }
        $mdDialog.hide();
        $location.path(<span class="hljs-string">'/portfolio/'</span> + $rootScope.loggedinUserInfo.id);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <h3>$scope.checkSharesReq</h3>

            </div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Checks the transaction queue for the amount of shares a user has placed there of a particular user. It also returns a
user object for the user selling the shares.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    $scope.checkSharesReq = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      TransactionHist.checkSharesAvail($scope.investment.target_id, <span class="hljs-string">'buy'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>)</span>{
        $scope.requestedShares = response[<span class="hljs-number">0</span>];
        $scope.requestedSharesInfo = response[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];
      });
    }
  }
})</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
